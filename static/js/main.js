(() => {
  const database = {
    premises: [
      {
        title: 'Nieuwbouwwoning wingene',
        intro: 'nieuwbouwwoning gelegen in een bosrijke, rustige omgeving.',
        slug: 'nieuwbouwwoning-met-3-slaapkamers-in-wildenburg-wingene',
        content: `
          <h2>Wonen in het groen</h2>
          <p>Deze alleenstaande gezinswoning met <strong>3 slaapkamers</strong> is voorzien van alle comfort en kwaliteitsmaterialen.</p>
          <p><strong>Gelijkvloers</strong><br>Een inkomhal met toilet, living met zithoek en eetkamer, geïnstalleerde keuken, een praktische berging, wasplaats,</p>
          <p><strong>Eerste verdiep</strong><br>3 slaapkamers en een badkamer met een mooie, betegelde en ruime inloopdouche.</p>
          <p>Extra troeven:</p>
          <ul>
              <li>Dubbele beglazing met draaikipsysteem</li>
              <li>centrale verwarming op gas</li>
              <li>buitenschrijnwerk in PVC</li>
              <li>regenwaterput van 5000 liter</li>
              <li>Ruime tuin.</li>
          </ul>
          <p>Droomt u van een eigen stek in de groene omgeving van Wingene? We helpen u graag verder. Contacteer ons op het nummer <a href="tel:+32495252263">0495 25 22 63</a> of stuur ons uw vraag via <a href="https://matthiastalloen.be/wp-admin/info@matthiastalloen.be">info@matthiastalloen.be</a>.</p>
        `,
        headImage: '../../static/images/te-koop/wingene/image-detail-head.jpeg',
        propertiesBuilding: [
          {
            name: 'Slaapkamers',
            value: '3',
          },
          {
            name: 'Badkamers',
            value: '1',
          },
          {
            name: 'Bewoonbare oppervlaktes',
            value: '129m²',
          },
          {
            name: 'Grondoppervlakte',
            value: '412 m²',
          },
          {
            name: 'E-peil',
            value: '',
          },
          {
            name: 'Verwarming',
            value: 'Gas',
          },
          {
            name: 'Oriëntatie tuin',
            value: 'Zuid',
          },
          {
            name: 'Oplevering',
            value: '01-05-2019',
          },
        ],
        address: {
          street: 'Varendreef',
          number: 93,
          zipCode: 8750,
          city: 'Wingene',
          coordinates: {
            lat: 51.095745,
            lng: 3.298018,
          }
        },
        properties: [
          {
            price: 292500,
            sold: false,
            media: [
              {
                src: '../images/te-koop/wingene/IMG_9624-cover2.jpeg',
                isThumb: true,
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-1.jpg',
                isThumb: false,
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-3.jpg',
                isThumb: false,
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-5.jpg',
                isThumb: false,
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-7.jpg',
                isThumb: false,               
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-9.jpg',
                isThumb: false,               
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-11.jpg',
                isThumb: false,               
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-13.jpg',
                isThumb: false,               
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-15.jpg',
                isThumb: false,              
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-17.jpg',
                isThumb: false,              
                note: 'Achtergevel in opbouw',
              },
              {
                src: '../../static/images/te-koop/wingene/img-20.jpg',
                isThumb: false,     
                note: 'Voorgevel in opbouw',
              },
              {
                src: '../../static/images/te-koop/wingene/img-22.jpg',
                isThumb: false,        
                note: 'Voorgevel in opbouw',
              },
              {
                src: '../../static/images/te-koop/wingene/img-2.jpg',
                isThumb: false,         
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-4.jpg',
                isThumb: false,     
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-6.jpg',
                isThumb: false,  
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-8.jpg',
                isThumb: false,
                
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-10.jpg',
                isThumb: false,        
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-12.jpg',
                isThumb: false,           
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-14.jpg',
                isThumb: false,   
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-16.jpg',
                isThumb: false,   
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-18.jpg',
                isThumb: false,     
                note: '',
              },
              {
                src: '../../static/images/te-koop/wingene/img-19.jpg',
                isThumb: false,   
                note: 'Achtergevel in opbouw',
              },
              {
                src: '../../static/images/te-koop/wingene/img-21.jpg',
                isThumb: false, 
                note: '',
              },
            ]
          }
        ],
        city: 'wingene',
      },
      {
        title: 'alleenstaande pastoriewoning in wingene',
        intro: 'Ruime alleenstaande woning',
        slug: '',
        content: `
        `,
        headImage: '../../images/te-koop/wingene-pastorie/IMG_9624-cover-761x900.jpg',
        propertiesBuilding: [
          
        ],
        address: {
          
        },
        properties: [
          {
            price: 292500,
            sold: true,
            media: [
              {
                src: '../images/te-koop/wingene-pastorie/IMG_9624-cover-761x900.jpg',
                isThumb: true,
                note: '',
              },
            ],
          }
        ],
      },
      {
        title: 'Appartementen in oostveld',
        intro: 'Vijf nieuwbouwappartementen in het rustige oostveld',
        slug: '',
        content: `
        `,
        headImage: '../../images/te-koop/oostveld/oostveld-01.jpg',
        propertiesBuilding: [
          
        ],
        address: {
          street: 'Tinhoutstraat',
          number: 120,
          zipCode: 8730,
          city: 'Beernem',
          coordinates: {
            lat: 51.161008,
            lng: 3.390056,
          }
        },
        properties: [{
            title: 'appartement 101',
            bedrooms: '2',
            price: 220000,
            sold: false,
            media: [{
              src: '../images/te-koop/oostveld/oostveld-01.jpg',
              isThumb: true,
            }, ],
            type: 'appartement'
          },
          {
            title: 'appartement 201',
            bedrooms: '1',
            price: 220000,
            sold: true,
            media: [{
              src: '../images/te-koop/oostveld-02.jpg',
              isThumb: false,
            }, ],
            type: 'appartement'
          },
        ],
        city: 'wingene',
      },
      {
        title: 'Nieuwbouwwoningen Doomkerke',
        intro: 'Drie geschakelde nieuwbouwwoningen',
        slug: '',
        content: `
        `,
        headImage: '../../images/te-koop/doomkerke/doomkerkerpano-600x445.JPG',
        propertiesBuilding: [
          
        ],
        address: {
          street: 'Brugsesteenweg',
          number: 79,
          zipCode: 8755,
          city: 'Ruislede',
          coordinates: {
            lat: 51.076999,
            lng: 3.353159,
          }
        },
        properties: [
          {
            price: 292500,
            sold: true,
            media: [
              {
                src: '../images/te-koop/doomkerke/doomkerkerpano-600x445.JPG',
                isThumb: true,
                note: '',
              },
            ],
          type: 'huis'
        }],
        city: 'ruislede',
      },
    ]
  }

  const app = {
    init() {
      this.cacheElements();
      if (this.mapContactElement !== null) {
        this.placePointer({lat: 51.128666, lng: 3.266715});
      }

      if (this.detailBreadcrumb !== null && this.detailTitle !== null && this.detailIntro !== null && this.detailContent !== null && this.detailImages !== null) {
        this.generateDetailTeKoop();
      }

      if (this.mapTeKoop !== null) {
        this.placePointersTeKoop();
      }

      this.generateItemsTekoop();
      this.filterPremises()
    },

    cacheElements() {
      this.mapContactElement = document.querySelector('.map-contact'); 
      this.cardsTeKoop = document.querySelector('[data-label="te-koop-items"');
      this.detailBreadcrumb = document.querySelector('[data-label="detail-breadcrumb"]');
      this.detailTitle = document.querySelector('[data-label="detail-title"]');
      this.detailIntro = document.querySelector('[data-label="detail-intro"]');
      this.detailContent = document.querySelector('[data-label="detail-content"]');
      this.detailPrice = document.querySelector('[data-label="detail-price"]');
      this.detailImages = document.querySelector('[data-label="detail-images"]');
      this.containerCardsPremises = document.querySelector('[data-label="te-koop-items"');
      this.relatedItems = document.querySelector('.related');
      this.mapTeKoop = document.querySelector('.map-te-koop');
      this.rasterBtn = document.querySelector('.raster-btn');
      this.mapBtn = document.querySelector('.map-btn');

      const bodyElement = document.body;
      const btnToggleElement = document.querySelector('.btn-hamburger');
      
      btnToggleElement.addEventListener('click', (ev) => {
        if (bodyElement.classList.contains('nav-isopen')) {
          bodyElement.classList.remove('nav-isopen');
        } 
        else {
          bodyElement.classList.add('nav-isopen');
        }
      });

      if (this.rasterBtn !== null && this.mapBtn !== null) {
        this.rasterBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          this.rasterBtn.classList.add('selected');
          this.mapBtn.classList.remove('selected');
          this.cardsTeKoop.classList.add('active-te-koop');
          this.cardsTeKoop.classList.remove('hidden-te-koop');
          this.mapTeKoop.classList.add('hidden-te-koop');
          this.mapTeKoop.classList.remove('active-te-koop');
        })
  
        this.mapBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          this.rasterBtn.classList.remove('selected');
          this.mapBtn.classList.add('selected');
          this.cardsTeKoop.classList.remove('active-te-koop');
          this.cardsTeKoop.classList.add('hidden-te-koop');
          this.mapTeKoop.classList.remove('hidden-te-koop');
          this.mapTeKoop.classList.add('active-te-koop');
        })
      }

      
    },
    placePointer(coordinates, page = 'other') {
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        zoom: 12,
        center: [coordinates.lng, coordinates.lat], // , 
      });

      let pre = '../'

      if (page === 'detail') {
        pre = '../../'
      }

      map.on('load', function() {
        map.loadImage(pre + 'static/images/marker.png', function(error, image) {
        if (error) throw error;
        map.addImage('marker', image);
          map.addLayer({
          "id": "points",
          "type": "symbol",
          "source": {
              "type": "geojson",
              "data": {
                "type": "FeatureCollection",
                "features": [{
                  "type": "Feature",
                  "geometry": {
                    "type": "Point",
                    "coordinates": [coordinates.lng, coordinates.lat]
                  }
                }]
              }
            },
            "layout": {
              "icon-image": "marker",
              "icon-size": 0.25
            }
          });
        });
      });
    },
    placePointersTeKoop() {
      const coordinatesFirst = database.premises[0].address.coordinates;
      const arrayFeatures = [];

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        zoom: 10,
        center: [coordinatesFirst.lng, coordinatesFirst.lat], // , 
      });

      database.premises.forEach((item, index) => {
        this.generateThumbPath(item.properties[0].media);

        // console.log(`premise ${++index} = ${item.title}`)
        // item.media !== undefined ? console.log(this.generateThumbPath(item.media)) : console.log('null');

        if (item.properties.length == 1) {
          // 1 LOT
          item.properties[0].sold ? this.meta = 'verkocht' : this.meta = this.priceFormat('€ ', item.properties[0].price);
        } else {
          // MEERDERE LOTEN
          this.meta = `${item.properties.length} loten`;
        }

        tempStr = `
          <a class="related-card-box" href="./${item.slug}/">
            <div class="related-card">
              <div class="related-image">
                <img data-lazy="${this.tumbPath.replace('../', '../../static/')}" alt="">
                <div class="meta">
                  ${this.meta}
                </div>
              </div>
              <div class="related-body p-16">
                <h3>${item.title}</h3>
                <p>${item.intro}</p>
              </div>
            </div>
          </a>
        `;

        if (item.address.coordinates !== undefined) {
          arrayFeatures.push({
            "type": "Feature",
            "properties": {
              "description": tempStr,
            },
            "geometry": {
              "type": "Point",
              "coordinates": [item.address.coordinates.lng, item.address.coordinates.lat],
            }
          });
        }
      });


      map.on('load', function() {
        map.loadImage('../static/images/marker-tekoop.png', function(error, image) {
        if (error) throw error;
        map.addImage('marker', image);
          

          map.addLayer({
            "id": "premises",
            "type": "symbol",
            "source": {
              "type": "geojson",
              "data": {
                "type": "FeatureCollection",
                "features": arrayFeatures,
              }
            },
            "layout": {
              "icon-image": "marker",
              "icon-size": 0.25
            }
          });

          map.on('click', 'premises', function(e) {
            console.log(e)
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;
             
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
             
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
            });
        });
      });
    },
    generateItemsTekoop() {
      let tempStr = '', meta, tumbPath = '';
      if (this.containerCardsPremises !== null) {
        database.premises.forEach((item, index) => {
          this.generateThumbPath(item.properties[0].media);

          // console.log(`premise ${++index} = ${item.title}`)
          // item.media !== undefined ? console.log(this.generateThumbPath(item.media)) : console.log('null');

          if (item.properties.length == 1) {
            // 1 LOT
            item.properties[0].sold ? this.meta = 'verkocht' : this.meta = this.priceFormat('€ ', item.properties[0].price);
          } else {
            // MEERDERE LOTEN
            this.meta = `${item.properties.length} loten`;
          }

          tempStr += `
            <a class="flex-grid-item card premise" href="${item.slug !== undefined ? item.slug : ''}" data-filter="${this.listTypes(item.properties)}${item.city}, ${this.listPrices(item.properties)}">
              <div class="card-head">
                  <img data-lazy="${this.tumbPath.replace('../', '../static/')}" alt="">
                  <div class="meta">
                    ${this.meta}
                  </div>
              </div>
              <div class="card-body p-16">
                  <h3>${item.title}</h3>
                  <p>${item.intro}</p>
              </div>
            </a>
          `
        });
        this.containerCardsPremises.innerHTML = tempStr;
      }
    },

    generateItemsFeatured() {
      let tempStr = '', meta, tumbPath = '';
      if (this.containerCardsPremises !== null) {
        database.premises.forEach((item, index) => {
          this.generateThumbPath(item.properties[0].media);

          // console.log(`premise ${++index} = ${item.title}`)
          // item.media !== undefined ? console.log(this.generateThumbPath(item.media)) : console.log('null');

          if (item.properties.length == 1) {
            // 1 LOT
            item.properties[0].sold ? this.meta = 'verkocht' : this.meta = this.priceFormat('€ ', item.properties[0].price);
          } else {
            // MEERDERE LOTEN
            this.meta = `${item.properties.length} loten`;
          }

          tempStr += `
            <a class="flex-grid-item card premise" href="./${item.slug}/" data-filter="${this.listTypes(item.properties)}${item.city}, ${this.listPrices(item.properties)}">
              <div class="card-head">
                  <img data-lazy="${this.tumbPath.replace('../', '../static/')}" alt="">
                  <div class="meta">
                    ${this.meta}
                  </div>
              </div>
              <div class="card-body p-16">
                  <h3>${item.title}</h3>
                  <p>${item.intro}</p>
              </div>
            </a>
          `
        });
        this.containerCardsPremises.innerHTML = tempStr;
      }
    },
    generateDetailTeKoop() {
      const linkArray = window.location.href.split('/');

      const currentDetailItemArray = database.premises.filter(premise => premise.slug === linkArray[4]);
      const currentDetailItem = currentDetailItemArray[0];
      console.log(currentDetailItem);

      if (currentDetailItem !== undefined) {
        this.detailBreadcrumb.innerHTML = currentDetailItem.title;
        this.detailTitle.innerHTML = currentDetailItem.title;
        this.detailIntro.innerHTML = currentDetailItem.intro;
        this.detailPrice.innerHTML = this.getPriceBuilding(currentDetailItem.properties);

        this.detailContent.innerHTML = `
          <div class="col-12 col-sm-12 col-md-8 col-lg-8 col-xl-8">
            <div class="detail-head-pic"> 
              <img data-lazy="${currentDetailItem.headImage}" alt="">
            </div>
            <div class="detail-description">
                ${currentDetailItem.content}
            </div>
          </div>
          <div class="col-12 col-sm-12 col-md-4 col-lg-4 col-xl-4">
            <div id="map" class="map"></div>
            <div class="address-info">
                <h4>Locatie</h4>
                <address> 
                    ${currentDetailItem.address.street} ${currentDetailItem.address.number} <br>
                    ${currentDetailItem.address.zipCode} ${currentDetailItem.address.city}
                </address>
            </div>
            <div class="detail-properties">
                <table>
                    <tbody>
                        ${this.getPropsBuilding(currentDetailItem.propertiesBuilding)}                      
                    </tbody>
                </table>
            </div>
          </div>
        `
        this.detailImages.innerHTML = this.getAllDetailImages(currentDetailItem.properties[0].media);
        this.relatedItems.innerHTML = this.getRelatedItems(currentDetailItem.slug);
        this.placePointer(currentDetailItem.address.coordinates, 'detail')
      }
      
    },
    getPriceBuilding (props) {
      let tempStr = '';

      if (!props.isSold) {
        props.forEach(prop => {
          tempStr = `${this.priceFormat('€ ', prop.price)}`
        })
      }
      else {
        tempStr = 'VERKOCHT'
      }

      return tempStr;
    },
    getPropsBuilding(buildingProps) {
      let tempStr = '';
      console.log(buildingProps)
      buildingProps.forEach(buildingProp => {
        tempStr += `
          <tr>
            <th>${buildingProp.name}</th>
            <td>${buildingProp.value}</td>
          </tr>
        `
      })

      return tempStr;
    },
    getAllDetailImages(media) {
      let tempStr = '', note = '';
      let mediaFiltered = media.filter(image => !image.isThumb);

      for (let i = 0; i < mediaFiltered.length; i++) {
        if (i === 0 || i === Math.round(mediaFiltered.length / 2)) {
          if (i > 0 ) {
            tempStr += '</div>'
          }

          tempStr += '<div class="col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">';
        }

        console.log(mediaFiltered[i]);

        if (mediaFiltered[i].note !== '') {
          note = `
          <div class="note">
            <p>${mediaFiltered[i].note}</p>
          </div>
          `
        }

        tempStr += `
          <a class="detail-card" href="">
            <div class="detail-image">
                <img data-lazy="${mediaFiltered[i].src}" alt="">
                ${note}
            </div>
          </a>
        `;

        note = '';
      }

      tempStr += '</div>'

      return tempStr;
    },
    getRelatedItems(current) {
      const filteredPremises = database.premises.filter(building => building.slug !== current);

      let tempStr = '', meta, tumbPath = '';
          
      filteredPremises.forEach(item => {

        console.log(item);

        this.generateThumbPath(item.properties[0].media);

        if (item.properties.length == 1) {
          // 1 LOT
          item.properties[0].sold ? this.meta = 'verkocht' : this.meta = this.priceFormat('€ ', item.properties[0].price);
        } else {
          // MEERDERE LOTEN
          this.meta = `${item.properties.length} loten`;
        }

        tempStr += `
          <a class="col-12 col-sm-12 col-md-4 col-lg-4 col-xl-4 related-card-box" href="./${item.slug}/">
            <div class="related-card">
              <div class="related-image">
                <img data-lazy="${this.tumbPath.replace('../', '../../static/')}" alt="">
                <div class="meta">
                  ${this.meta}
                </div>
              </div>
              <div class="related-body p-16">
                <h3>${item.title}</h3>
                <p>${item.intro}</p>
              </div>
            </div>
          </a>
        `
      })

      return tempStr;
    },
    setDetailPointerMap() {
      
    },
    generateThumbPath(input) {
      input.forEach(r => {
        if (r.isThumb == true) {
          this.tumbPath = r.src;
        }
      })
    },

    priceFormat(prepend = '', input, append = '') {
      return prepend + input.toString().match(/.{1,3}/g).join('.') + append;
    },

    listPrices(input) {
      let tempStr = ''
      input.forEach((item) => {
        tempStr += `${item.price}, `;
      })

      return tempStr;
    },

    listTypes(input) {
      let tempStr = ''
      input.forEach((item) => {
        tempStr += `${item.type}, `;
      })

      return tempStr;
    },

    filterPremises() {
      const cardsPremises = document.querySelectorAll('.premise');
      let cardPremiseSearchString = '', 
          searchString = [this.getUrlVar('premise_type'),this.getUrlVar('premise_city'),this.getUrlVar('premise_price')];
      cardsPremises.forEach((item) => {
        cardPremiseSearchString = item.dataset.filter.split(', ');
        // check if data filer att includes searchstring
        if (searchString.some(v=> cardPremiseSearchString.indexOf(v) !== -1) || window.location.href.includes('?') == false) {
          return
        } else if (searchString.some(v=> cardPremiseSearchString.indexOf(v) == -1) && searchString !== [false, false, false]) {
          item.classList.add('d-none')
        }
      });
    },

    getUrlVar(variable) {
      var url = window.location.search.substring(1);
      var vars = url.split("&");
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) {
          return pair[1];
        }
      }
      return (false);
    }
  }

  app.init();
})();